-- phpMyAdmin SQL Dump
-- Drop existing tables if they exist
DROP TABLE IF EXISTS MAY_HAVE;
DROP TABLE IF EXISTS CUSTOMER;
DROP TABLE IF EXISTS HOTEL;
DROP TABLE IF EXISTS BOOKING;
DROP TABLE IF EXISTS PAYMENT;
DROP TABLE IF EXISTS ROOM_;

-- Create tables
CREATE TABLE PAYMENT (
   PAYMENT_ID INT AUTO_INCREMENT NOT NULL,
   AMOUNT DECIMAL(10,2),
   PAYMENT_DATE DATETIME,
   PAYMENT_METHOD_ VARCHAR(100),
   PAYMENT_STATUS VARCHAR(100),
   PRIMARY KEY (PAYMENT_ID)
) ENGINE=InnoDB;

CREATE TABLE ROOM_ (
   ROOM_ID INT AUTO_INCREMENT NOT NULL,
   HOTEL_ID_ INT,
   _ROOM_TYPE VARCHAR(100),
   ROOM_PRICE DECIMAL(10,2),
   CAPACITY INT,
   PRIMARY KEY (ROOM_ID)
) ENGINE=InnoDB;

CREATE TABLE HOTEL (
   HOTEL_ID INT AUTO_INCREMENT NOT NULL,
   ROOM_ID INT NOT NULL,
   ATTRIBUTHOTEL_NAME_E_2 VARCHAR(100),
   __LOCATION VARCHAR(100),
   CONTACT_NUMBER VARCHAR(100),
   _TOTAL_ROOMS INT,
   HOTEL_DESCRIPTION TEXT,
   PRIMARY KEY (HOTEL_ID),
   FOREIGN KEY (ROOM_ID) REFERENCES ROOM_(ROOM_ID)
) ENGINE=InnoDB;

CREATE TABLE CUSTOMER (
   CUSTOMER_ID INT AUTO_INCREMENT NOT NULL,
   FIRST_NAME VARCHAR(50),
   _LAST_NAME VARCHAR(50),
   _EMAIL VARCHAR(100),
   _PASSWORD VARCHAR(100), 
   PHONE_NUMBER VARCHAR(100),
   ADDRESS VARCHAR(255),
   PRIMARY KEY (CUSTOMER_ID)
) ENGINE=InnoDB;

CREATE TABLE BOOKING (
   BOOKING_ID INT AUTO_INCREMENT NOT NULL,
   PAYMENT_ID INT NOT NULL,
   CUSTOMER_ID INT NOT NULL,
   CHECK_IN_DATE DATETIME,
   CHECK_OUT_DATE DATETIME,
   NUMBER_OF_GUESTS_ INT,
   BOOKING_STATUS_ VARCHAR(100),
   PRIMARY KEY (BOOKING_ID),
   FOREIGN KEY (PAYMENT_ID) REFERENCES PAYMENT(PAYMENT_ID),
   FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID)
) ENGINE=InnoDB;

CREATE TABLE MAY_HAVE (
   ROOM_ID INT NOT NULL,
   BOOKING_ID INT NOT NULL,
   ROOM_BOOKING_ID INT AUTO_INCREMENT NOT NULL,
   PRIMARY KEY (ROOM_BOOKING_ID),
   FOREIGN KEY (ROOM_ID) REFERENCES ROOM_(ROOM_ID),
   FOREIGN KEY (BOOKING_ID) REFERENCES BOOKING(BOOKING_ID)
) ENGINE=InnoDB;

-- Create indexes
CREATE INDEX idx_room_hotel ON ROOM_(HOTEL_ID_);
CREATE INDEX idx_booking_customer ON BOOKING(PAYMENT_ID);
CREATE INDEX idx_may_have_room ON MAY_HAVE(ROOM_ID);
CREATE INDEX idx_may_have_booking ON MAY_HAVE(BOOKING_ID);
CREATE INDEX HAS2_FK ON PAYMENT(PAYMENT_ID);

-- Triggers
DELIMITER $$

CREATE TRIGGER check_email_exists_before_insert 
BEFORE INSERT ON customer
FOR EACH ROW
BEGIN
    DECLARE email_count INT;
    
    -- Check if the email already exists
    SELECT COUNT(*) INTO email_count FROM customer WHERE _EMAIL = NEW._EMAIL;
    
    IF email_count > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Email already exists';
    END IF;
END $$

DELIMITER ;
